# E-Torch 데이터 상태관리 가이드

## 1. 개요 및 설계 원칙

### 1.1 가이드 목적

E-Torch 프로젝트의 상태 관리는 경제지표 대시보드 서비스의 특성을 반영한 체계적인 접근법을 제공합니다. 이 가이드는 개발자가 일관되고 효율적인 상태 관리를 구현할 수 있도록 원칙과 지침을 제시합니다.

### 1.2 핵심 설계 원칙

- **계층적 분리**: 전역/기능/지역 상태의 명확한 구분
- **서버/클라이언트 분리**: 원격 데이터와 UI 상태의 독립적 관리
- **성능 최적화**: 선택적 구독과 메모이제이션을 통한 렌더링 최적화
- **확장성**: 새로운 위젯과 기능 추가를 고려한 유연한 구조
- **접근성**: 상태 변경 시 스크린 리더 호환성 유지

## 2. 상태 유형 분류 및 관리 전략

### 2.1 상태 분류 기준

| 상태 유형 | 지속성 | 범위 | 관리 도구 | 사용 예시 |
|----------|--------|------|----------|----------|
| **영구 상태** | 앱 재시작 후 유지 | 전역 | Zustand + persist | 사용자 설정, 테마 |
| **애플리케이션 상태** | 세션 동안 유지 | 전역 | Zustand | 인증, 알림, 에러 |
| **도메인 상태** | 기능별 유지 | 기능 범위 | Zustand, Context API | 차트/대시보드 에디터 |
| **UI 상태** | 컴포넌트 생명주기 | 지역 | useState, useReducer | 모달, 드롭다운 |
| **서버 상태** | 캐시 정책에 따라 | 전역 | TanStack Query | 경제지표 데이터 |

### 2.2 상태 분류 결정 가이드

**영구 상태 사용 시기:**

- 사용자 환경 설정 (테마, 언어, 알림 설정)
- 최근 작업 기록 (최근 대시보드, 즐겨찾기)

**애플리케이션 상태 사용 시기:**

- 인증 상태 및 사용자 정보
- 전역 에러 및 알림 메시지
- 구독 플랜 상태

**도메인 상태 사용 시기:**

- 대시보드 편집 상태
- 위젯 에디터 상태
- 차트 설정 및 옵션

**서버 상태 사용 시기:**

- KOSIS/ECOS 경제지표 데이터
- 대시보드/위젯 메타데이터
- 사용자 구독 정보

## 3. 기술 스택 및 선정 이유

### 3.1 상태 관리 도구

| 도구 | 사용 영역 | 선정 이유 |
|------|-----------|----------|
| **Zustand 5** | 클라이언트 상태 | 간결한 API, 유연한 미들웨어, React 19 호환성 |
| **TanStack Query 5** | 서버 상태 | 캐싱, 낙관적 업데이트, devtools, 성능 최적화 |
| **React Context** | 테마, 인증 | 깊은 컴포넌트 트리, 간단한 전역 상태 |
| **React Hook Form 7** | 폼 상태 | 비제어 컴포넌트, 성능 우수, 유효성 검사 |

### 3.2 미들웨어 활용

**Zustand 미들웨어:**

- **immer**: 불변성 관리 간소화
- **persist**: 상태 영속성 (localStorage, sessionStorage)
- **devtools**: 개발 도구 연동 (개발 환경만)
- **subscribeWithSelector**: 선택적 구독 최적화

## 4. 상태 계층 구조

### 4.1 계층별 책임

```
E-Torch 상태 계층
├── 영구 상태 계층 (사용자 설정, 테마, 최근 작업)
├── 애플리케이션 상태 계층 (인증, 전역 에러, 알림)
├── 도메인 상태 계층 (차트 에디터, 대시보드, 데이터 소스)
├── UI 상태 계층 (모달, 사이드바, 툴팁)
└── 서버 상태 계층 (원격 데이터 캐시, 쿼리 상태)
```

### 4.2 패키지 구조와 통합

**@e-torch/state 패키지 구조:**

- `stores/`: 도메인별 Zustand 스토어
- `hooks/`: 커스텀 훅 및 TanStack Query 훅
- `providers/`: Context Provider 컴포넌트
- `services/`: 상태 관련 유틸리티 서비스

## 5. 성능 최적화 가이드라인

### 5.1 선택적 구독 패턴

**권장사항:**

- 컴포넌트에서 필요한 상태만 구독
- selector 함수를 사용하여 불필요한 리렌더링 방지
- 복잡한 계산은 useMemo로 메모이제이션

**금지사항:**

- 전체 스토어를 구독하는 것
- selector 없이 중첩 객체 접근
- 렌더링 함수 내에서 새 객체/배열 생성

### 5.2 메모이제이션 전략

**적용 대상:**

- 비용이 큰 데이터 변환 로직
- 차트 통계 계산
- 필터링된 데이터 목록

**적용 방법:**

- React.memo로 컴포넌트 메모이제이션
- useMemo로 값 메모이제이션
- useCallback으로 함수 메모이제이션

### 5.3 상태 정규화

**정규화 적용 기준:**

- 중첩된 데이터 구조
- 여러 곳에서 참조되는 데이터
- 대량의 목록 데이터

**정규화 구조:**

- `byId`: ID를 키로 하는 객체
- `allIds`: ID 배열
- 관계 테이블: 엔티티 간 관계 매핑

## 6. 서버 상태 관리

### 6.1 TanStack Query 설정 가이드

**캐시 정책:**

- `staleTime`: 데이터 신선도 (5분-1시간)
- `gcTime`: 가비지 컬렉션 (10분-2시간)
- `refetchInterval`: 자동 리페치 (5분, 선택적)

**쿼리 키 설계:**

- 계층적 구조: `['dashboards', 'detail', id]`
- 필터 조건 포함: `['charts', 'data', { period, range }]`

### 6.2 경제지표 데이터 관리

**데이터 특성:**

- 정기 업데이트 (실시간 아님)
- 대량 시계열 데이터
- 플랜별 접근 제한

**캐싱 전략:**

- 과거 데이터: 24시간 캐시
- 최신 데이터: 30분-1시간 캐시
- 메타데이터: 24시간 캐시

## 7. 구독 모델 상태 관리

### 7.1 플랜별 권한 검증

**권한 상태 구조:**

- 현재 구독 플랜 (Basic/Pro)
- 사용량 현황 (대시보드/위젯 수)
- 접근 권한 (지표/기간 제한)

**캐싱 전략:**

- 권한 정보: 5분 캐시
- 사용량 정보: 실시간 업데이트
- 구독 상태: 세션 기간 캐시

### 7.2 제한 사항 UI 반영

**제한 표시 방법:**

- 진행바로 사용량 표시
- 비활성화된 기능 시각적 구분
- 업그레이드 안내 적절한 타이밍

## 8. 개발 가이드라인

### 8.1 상태 생성 가이드라인

**스토어 생성 시:**

- 단일 책임 원칙 준수
- 타입 안전성 보장
- 액션과 상태 명확히 분리

**훅 생성 시:**

- 재사용 가능한 로직 추상화
- 에러 처리 포함
- 로딩 상태 관리

### 8.2 디버깅 가이드라인

**개발 환경에서:**

- Zustand devtools 활성화
- TanStack Query devtools 사용
- 상태 변경 로그 기록

**프로덕션 환경에서:**

- devtools 비활성화
- 에러 모니터링 연동
- 성능 메트릭 수집

### 8.3 테스트 가이드라인

**단위 테스트:**

- 스토어 액션 동작 검증
- 훅 반환값 검증
- 에러 케이스 테스트

**통합 테스트:**

- 컴포넌트-상태 연동 테스트
- 서버 상태 캐싱 검증
- 권한 제한 동작 확인

## 9. 주의사항 및 베스트 프랙티스

### 9.1 피해야 할 패턴

- 전역 상태에 UI 상태 저장
- 서버 상태를 클라이언트 상태로 복사
- 무분별한 상태 정규화
- 과도한 컴포넌트 메모이제이션

### 9.2 권장 패턴

- 상태 유형별 적절한 도구 선택
- 명확한 상태 소유권 정의
- 일관된 에러 처리 패턴
- 접근성 고려한 상태 업데이트

### 9.3 성능 모니터링

**모니터링 대상:**

- 불필요한 리렌더링 횟수
- 메모리 사용량 증가
- 네트워크 요청 중복
- 캐시 적중률

**개선 기준:**

- 컴포넌트 렌더링 시간 < 16ms
- 메모리 사용량 < 200MB
- 캐시 적중률 > 80%
- API 요청 중복 < 5%

이 가이드를 따라 E-Torch의 상태 관리를 구현하면 확장 가능하고 성능이 우수한 경제지표 대시보드 서비스를 구축할 수 있습니다.
