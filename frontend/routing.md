# E-Torch 라우팅 구조 가이드

## 1. 개요

### 1.1 설계 원칙

E-Torch는 Next.js 15 App Router 기반의 **국제화 우선 라우팅 구조**를 채택합니다.

**핵심 설계 결정사항:**

- **[locale] 최상위 구조**: SEO 최적화 및 명확한 언어 구분
- **라우트 그룹**: 기능별 코드 조직화 및 레이아웃 분리
- **구독 모델 통합**: 미들웨어 레벨 권한 검증
- **성능 최적화**: 서버 컴포넌트 우선, 점진적 개선

### 1.2 지원 언어 및 URL 구조

| 언어 | 코드 | URL 예시 | 우선순위 |
|------|------|----------|----------|
| 한국어 | ko | `/ko/dashboard` | 기본 (기준) |
| 영어 | en | `/en/dashboard` | 글로벌 확장용 |

## 2. 라우팅 구조

### 2.1 전체 구조 개요

```
app/
├── [locale]/                    # 국제화 라우트
│   ├── (auth)/                  # 인증 그룹
│   ├── (dashboard)/             # 대시보드 그룹  
│   ├── (widget)/                # 위젯 그룹
│   ├── (subscription)/          # 구독 그룹
│   ├── (profile)/               # 프로필 그룹
│   ├── accessibility/           # 접근성 지원
│   ├── layout.tsx               # 언어별 레이아웃
│   └── page.tsx                 # 홈페이지
├── api/                         # API 라우트 (언어 무관)
├── middleware.ts                # 언어/인증/구독 검증
├── layout.tsx                   # 루트 레이아웃
└── page.tsx                     # 언어 리디렉션
```

### 2.2 인증 그룹 (auth)

| 라우트 | 한국어 | 영어 | 기능 | 권한 |
|--------|--------|------|------|------|
| 로그인 | `/ko/login` | `/en/login` | SNS 로그인 (Google, Naver, Kakao) | Public |
| 콜백 | `/ko/callback` | `/en/callback` | OAuth 콜백 처리 | Public |

### 2.3 대시보드 그룹 (dashboard)

| 라우트 | 한국어 | 영어 | 기능 | 구독 제한 |
|--------|--------|------|------|---------|
| 목록 | `/ko/dashboard` | `/en/dashboard` | 대시보드 목록 | Basic: 3개 |
| 상세 | `/ko/dashboard/[id]` | `/en/dashboard/[id]` | 대시보드 조회 | 워터마크 |
| 생성 | `/ko/dashboard/new` | `/en/dashboard/new` | 새 대시보드 | Basic: 3개 한도 |
| 편집 | `/ko/dashboard/[id]/edit` | `/en/dashboard/[id]/edit` | 대시보드 편집 | 소유자만 |
| 탐색 | `/ko/explore` | `/en/explore` | 공개 대시보드 탐색 | Basic: 복사 불가 |

### 2.4 위젯 그룹 (widget)

| 라우트 | 한국어 | 영어 | 기능 | 지원 위젯 |
|--------|--------|------|------|----------|
| 에디터 | `/ko/widget-editor/[id]` | `/en/widget-editor/[id]` | 위젯 에디터 | 7가지 타입 |
| 상세 | `/ko/widget/[id]` | `/en/widget/[id]` | 위젯 상세 | 모든 타입 |

**위젯 타입:**

- **차트형 (5가지)**: TimeSeries, BarChart, ScatterChart, RadarChart, RadialBarChart
- **텍스트형 (2가지)**: 사용자 정의, 데이터 기반

### 2.5 구독 그룹 (subscription)

| 라우트 | 한국어 | 영어 | 기능 | 연동 |
|--------|--------|------|------|------|
| 업그레이드 | `/ko/subscription/upgrade` | `/en/subscription/upgrade` | Pro 플랜 업그레이드 | 토스페이먼츠 |
| 빌링 | `/ko/subscription/billing` | `/en/subscription/billing` | 결제 관리 | 빌링키 |
| 체험 | `/ko/subscription/trial` | `/en/subscription/trial` | 7일 무료 체험 | - |
| 결제 처리 | `/ko/subscription/payment/*` | `/en/subscription/payment/*` | success/fail/cancel | 토스페이먼츠 |

**제한 도달 안내 페이지:**

- `/subscription/limit-reached/dashboard` - 대시보드 한도 (3개)
- `/subscription/limit-reached/widget` - 위젯 한도 (6개)  
- `/subscription/limit-reached/data-period` - 데이터 기간 제한 (3년)

### 2.6 프로필 그룹 (profile)

| 라우트 | 한국어 | 영어 | 기능 |
|--------|--------|------|------|
| 설정 | `/ko/profile/settings` | `/en/profile/settings` | 프로필 편집, 언어 설정 |
| 알림 | `/ko/profile/notifications` | `/en/profile/notifications` | 구독 갱신 알림 설정 |

### 2.7 접근성 지원

| 라우트 | 한국어 | 영어 | 기능 |
|--------|--------|------|------|
| 통합 접근성 | `/ko/accessibility` | `/en/accessibility` | 키보드, 스크린 리더, 고대비 가이드 |

## 3. API 라우팅

### 3.1 API 구조 (언어 무관)

```
app/api/
├── auth/                        # Supabase Auth
├── data/                        # 경제지표 데이터
│   ├── kosis/                   # KOSIS 데이터 (12개 지표)
│   └── ecos/                    # ECOS 데이터 (8개 지표)
├── dashboards/                  # 대시보드 CRUD
├── widgets/                     # 위젯 CRUD  
├── payments/                    # 토스페이먼츠
└── subscription/                # 구독 관리
```

### 3.2 구독 플랜별 데이터 제한

| 플랜 | 제공 지표 | 데이터 기간 | 대시보드 | 위젯 | 특별 기능 |
|------|----------|------------|----------|------|----------|
| **Basic** | 20개 (KOSIS 12개 + ECOS 8개) | 최근 3년 | 3개 | 6개/대시보드 | 워터마크 |
| **Pro** | 40개 (전체) | 전체 기간 | 무제한 | 무제한 | 복사, 임베드 |

## 4. 미들웨어 구조

### 4.1 미들웨어 체인

1. **언어 감지**: Accept-Language 기반 자동 리디렉션
2. **라우트 필터링**: API, 정적 파일, 공개 페이지 패스  
3. **인증 검증**: Supabase 세션 확인 (JWT 로컬 검증 우선)
4. **구독 검증**: 플랜별 접근 권한 확인 (5분 캐시)

### 4.2 권한 검증 로직

```
사용자 요청 → 캐시 확인 (5분) → 권한 검증 → UI 제한 적용
                ↓
          미들웨어 리디렉션 (제한 도달 시)
```

## 5. 레이아웃 시스템

### 5.1 계층적 레이아웃

| 레이아웃 | 책임 | 특징 |
|---------|------|------|
| **RootLayout** | 전역 CSS, 테마, 메타데이터 | 언어 리디렉션 |
| **LocaleLayout** | 언어별 사전, 방향성 설정 | RTL/LTR 지원 |
| **그룹별 레이아웃** | 네비게이션, 헤더, 전용 UI | 기능별 최적화 |

### 5.2 반응형 브레이크포인트

| 화면 구분 | 크기 | 헤더 높이 | 사이드바 | 그리드 |
|----------|------|----------|---------|--------|
| **데스크톱** | 1200px+ | 80px | 200px 고정 | 12컬럼 |
| **태블릿** | 768px-1199px | 72px | 접이식 | 8컬럼 |
| **모바일** | ~767px | 64px | 드로어 | 4컬럼 |

## 6. 성능 최적화

### 6.1 캐싱 전략

| 데이터 유형 | 캐시 시간 | 적용 범위 |
|------------|----------|----------|
| **과거 데이터** | 24시간 | 브라우저 + CDN |
| **최신 데이터** | 15-30분 | TanStack Query |
| **사용자 권한** | 5분 | 미들웨어 |
| **지표 목록** | 24시간 | 서버 캐시 |

### 6.2 Core Web Vitals 목표

| 지표 | 목표값 | 측정 도구 |
|------|--------|----------|
| **LCP** | < 2.5초 | Web Vitals API |
| **FID/INP** | < 100ms | Web Vitals API |
| **CLS** | < 0.1 | Web Vitals API |

## 7. 에러 처리

### 7.1 계층별 에러 바운더리

| 계층 | 에러 유형 | Fallback UI |
|------|----------|------------|
| **차트 레벨** | 렌더링 실패 | 에러 메시지 + 재시도 |
| **위젯 레벨** | 데이터 로딩 실패 | 스켈레톤 + 오류 아이콘 |
| **대시보드 레벨** | 레이아웃 오류 | 부분 복구 + 전체 재로드 |
| **앱 레벨** | 예상치 못한 오류 | 전체 앱 재시작 |

### 7.2 언어별 에러 처리

- 구독 제한 에러: 플랜별 맞춤형 업그레이드 안내
- 네트워크 에러: 재시도 버튼 + 연결 상태 안내
- 권한 에러: 로그인 유도 + 현재 페이지 기억

## 8. 접근성 지원

### 8.1 WCAG 2.1 AA 준수

| 요구사항 | 구현 방법 |
|----------|----------|
| **키보드 네비게이션** | Tab 순서 + Skip Links |
| **스크린 리더** | 의미적 HTML + ARIA 라벨 |
| **색상 대비** | 4.5:1 이상 + 색상 외 구별 |
| **터치 최적화** | 44×44px 타겟 + 8px 간격 |

### 8.2 다국어 접근성

- 언어별 Skip Navigation 제공
- 언어 전환 UI (플래그 + 언어명)
- 방향성 자동 감지 (RTL/LTR)

## 9. 주요 설계 고려사항

### 9.1 라우팅 설계 원칙

- **일관성**: 모든 언어에서 동일한 URL 패턴 유지
- **예측 가능성**: 사용자가 URL 구조를 직관적으로 이해
- **확장성**: 새로운 기능 추가 시 기존 구조 변경 최소화
- **성능**: 서버 컴포넌트 우선 및 적절한 캐싱 적용

### 9.2 기술적 제약사항

- **미들웨어 순서**: 언어 → 인증 → 구독 검증 순서 준수
- **권한 검증**: 구독 플랜별 라우트 보호는 미들웨어에서 처리
- **에러 처리**: 각 라우트 그룹별 적절한 에러 바운더리 설정
- **메타데이터**: 언어별 SEO 최적화를 위한 동적 메타데이터 생성
